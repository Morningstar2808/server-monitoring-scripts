#!/bin/bash
# –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π
# –° –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç–∞

if [ $# -lt 4 ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: curl -fsSL https://raw.githubusercontent.com/Morningstar2808/server-monitoring-scripts/master/add | bash -s SERVER_NAME TAILSCALE_IP ANGIE_PORT CADVISOR_PORT [--force]"
    echo "–ü—Ä–∏–º–µ—Ä: curl -fsSL https://raw.githubusercontent.com/Morningstar2808/server-monitoring-scripts/master/add | bash -s \"rocket\" \"100.77.125.71\" \"\" \"9080\" --force"
    echo "  - –£–∫–∞–∂–∏—Ç–µ \"\" –¥–ª—è –ø–æ—Ä—Ç–∞, –µ—Å–ª–∏ –æ–Ω –Ω–µ –Ω—É–∂–µ–Ω (ANGIE_PORT –≤—Å–µ–≥–¥–∞ 3-–π, CADVISOR_PORT –≤—Å–µ–≥–¥–∞ 4-–π)."
    echo "  - --force –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."
    exit 1
fi

SERVER_NAME="$1"
TAILSCALE_IP="$2"
ANGIE_PORT="$3"
CADVISOR_PORT="$4"
FORCE_ARG=""
if [ "${5:-}" = "--force" ]; then
    FORCE_ARG="--force"
fi

echo "=== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ==="
echo "–°–µ—Ä–≤–µ—Ä: $SERVER_NAME"
echo "IP: $TAILSCALE_IP"
echo "Angie –ø–æ—Ä—Ç: ${ANGIE_PORT:-–Ω–µ —É–∫–∞–∑–∞–Ω}"
echo "cAdvisor –ø–æ—Ä—Ç: ${CADVISOR_PORT:-–Ω–µ —É–∫–∞–∑–∞–Ω}"
if [ -n "$FORCE_ARG" ]; then echo "–†–µ–∂–∏–º: force (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)"; fi
echo ""

SCRIPT_NAME="add_server_to_monitoring.sh"
SCRIPT_URL="https://raw.githubusercontent.com/Morningstar2808/server-monitoring-scripts/master/$SCRIPT_NAME"
NEED_DOWNLOAD=true

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–∫—Ä–∏–ø—Ç –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ª–∏ –æ–Ω
if [ -f "$SCRIPT_NAME" ]; then
    echo "üìÑ –ù–∞–π–¥–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç $SCRIPT_NAME"
    
    if [ $(find "$SCRIPT_NAME" -mtime -1 2>/dev/null | wc -l) -gt 0 ]; then
        echo "‚úÖ –°–∫—Ä–∏–ø—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π (–æ–±–Ω–æ–≤–ª–µ–Ω –º–µ–Ω–µ–µ —Å—É—Ç–æ–∫ –Ω–∞–∑–∞–¥)"
        NEED_DOWNLOAD=false
    else
        echo "‚ö†Ô∏è  –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞—Ä–µ–ª, –æ–±–Ω–æ–≤–ª—è–µ–º..."
    fi
fi

# –°–∫–∞—á–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ "$NEED_DOWNLOAD" = true ]; then
    echo "‚¨áÔ∏è  –°–∫–∞—á–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç..."
    if ! wget -q "$SCRIPT_URL" -O "$SCRIPT_NAME"; then
        echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞"
        exit 1
    fi
    chmod +x "$SCRIPT_NAME"
    echo "‚úÖ –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω"
fi

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞..."

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
./"$SCRIPT_NAME" "$SERVER_NAME" "$TAILSCALE_IP" "$ANGIE_PORT" "$CADVISOR_PORT" "$FORCE_ARG"

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"

