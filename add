#!/bin/bash
# –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π
# –í–µ—Ä—Å–∏—è 2.2.0 - –≤—Å–µ–≥–¥–∞ —Å–∫–∞—á–∏–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é

if [ $# -lt 4 ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: curl -fsSL https://raw.githubusercontent.com/Morningstar2808/server-monitoring-scripts/master/add | bash -s SERVER_NAME TAILSCALE_IP ANGIE_PORT CADVISOR_PORT [--force]"
    echo "–ü—Ä–∏–º–µ—Ä: curl -fsSL https://raw.githubusercontent.com/Morningstar2808/server-monitoring-scripts/master/add | bash -s \"rocket\" \"100.77.125.71\" \"8082\" \"9080\" --force"
    echo "  - –£–∫–∞–∂–∏—Ç–µ \"\" –¥–ª—è –ø–æ—Ä—Ç–∞, –µ—Å–ª–∏ –æ–Ω –Ω–µ –Ω—É–∂–µ–Ω"
    echo "  - --force –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
    exit 1
fi

SERVER_NAME="$1"
TAILSCALE_IP="$2"
ANGIE_PORT="$3"
CADVISOR_PORT="$4"
FORCE_ARG="${5:-}"

echo "=== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ==="
echo "–°–µ—Ä–≤–µ—Ä: $SERVER_NAME"
echo "IP: $TAILSCALE_IP"
echo "Angie –ø–æ—Ä—Ç: ${ANGIE_PORT:-–Ω–µ —É–∫–∞–∑–∞–Ω}"
echo "cAdvisor –ø–æ—Ä—Ç: ${CADVISOR_PORT:-–Ω–µ —É–∫–∞–∑–∞–Ω}"
if [ "$FORCE_ARG" = "--force" ]; then echo "–†–µ–∂–∏–º: force"; fi
echo ""

SCRIPT_NAME="add_server_to_monitoring.sh"
SCRIPT_URL="https://raw.githubusercontent.com/Morningstar2808/server-monitoring-scripts/master/$SCRIPT_NAME"

# –í—Å–µ–≥–¥–∞ —Å–∫–∞—á–∏–≤–∞–µ–º —Å–≤–µ–∂—É—é –≤–µ—Ä—Å–∏—é
echo "‚¨áÔ∏è  –°–∫–∞—á–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç..."
if wget -q -O "$SCRIPT_NAME" "$SCRIPT_URL" 2>/dev/null || curl -fsSL -o "$SCRIPT_NAME" "$SCRIPT_URL" 2>/dev/null; then
    chmod +x "$SCRIPT_NAME"
    echo "‚úÖ –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞"
    exit 1
fi

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞..."

./"$SCRIPT_NAME" "$SERVER_NAME" "$TAILSCALE_IP" "$ANGIE_PORT" "$CADVISOR_PORT" "$FORCE_ARG"

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
