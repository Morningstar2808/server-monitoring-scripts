#!/bin/bash
# –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π
# –° –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç–∞

if [ $# -ne 1 ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: curl -fsSL https://raw.githubusercontent.com/Morningstar2808/server-monitoring-scripts/master/remove | bash -s SERVER_NAME"
    echo "–ü—Ä–∏–º–µ—Ä: curl -fsSL https://raw.githubusercontent.com/Morningstar2808/server-monitoring-scripts/master/remove | bash -s \"web-server-01\""
    exit 1
fi

SERVER_NAME="$1"

echo "=== –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ ==="
echo "–°–µ—Ä–≤–µ—Ä: $SERVER_NAME"
echo ""

SCRIPT_NAME="remove_server_from_monitoring.sh"
SCRIPT_URL="https://raw.githubusercontent.com/Morningstar2808/server-monitoring-scripts/master/$SCRIPT_NAME"
NEED_DOWNLOAD=true

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–∫—Ä–∏–ø—Ç –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ª–∏ –æ–Ω
if [ -f "$SCRIPT_NAME" ]; then
    echo "üìÑ –ù–∞–π–¥–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç $SCRIPT_NAME"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ —Å—Ç–∞—Ä—à–µ 1 –¥–Ω—è - –æ–±–Ω–æ–≤–ª—è–µ–º)
    if [ $(find "$SCRIPT_NAME" -mtime -1 2>/dev/null | wc -l) -gt 0 ]; then
        echo "‚úÖ –°–∫—Ä–∏–ø—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π (–æ–±–Ω–æ–≤–ª–µ–Ω –º–µ–Ω–µ–µ —Å—É—Ç–æ–∫ –Ω–∞–∑–∞–¥)"
        NEED_DOWNLOAD=false
    else
        echo "‚ö†Ô∏è  –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞—Ä–µ–ª, –æ–±–Ω–æ–≤–ª—è–µ–º..."
    fi
fi

# –°–∫–∞—á–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ "$NEED_DOWNLOAD" = true ]; then
    echo "‚¨áÔ∏è  –°–∫–∞—á–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç..."
    if ! wget -q "$SCRIPT_URL"; then
        echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞"
        exit 1
    fi
    chmod +x "$SCRIPT_NAME"
    echo "‚úÖ –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω"
fi

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞..."

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
./"$SCRIPT_NAME" "$SERVER_NAME"

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
